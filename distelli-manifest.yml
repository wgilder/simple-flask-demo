# Puppet Pipelines demo, v4
walter.gildersleeve/simple-flask-demo:
  Env:
  PreBuild:
    - echo DISTELLI_APPHOME == $DISTELLI_APPHOME
    - echo DISTELLI_APPNAME == $DISTELLI_APPNAME
    - echo DISTELLI_BUILDNUM == $DISTELLI_BUILDNUM
    - echo DISTELLI_ENV == $DISTELLI_ENV
    - echo DISTELLI_INSTALLHOME == $DISTELLI_INSTALLHOME
    - echo DISTELLI_RELBRANCH == $DISTELLI_RELBRANCH
    - echo DISTELLI_RELEASE == $DISTELLI_RELEASE
    - echo DISTELLI_RELREPOTYPE == $DISTELLI_RELREPOTYPE
    - echo DISTELLI_RELREVISION == $DISTELLI_RELREVISION
    - echo DISTELLI_RELVERSION == $DISTELLI_RELVERSION
    - echo DISTELLI_DOCKER_USERNAME == $DISTELLI_DOCKER_USERNAME
    - echo DISTELLI_DOCKER_PW == $DISTELLI_DOCKER_PW
    - echo DISTELLI_DOCKER_EMAIL == $DISTELLI_DOCKER_EMAIL
    - echo DISTELLI_DOCKER_ENDPOINT == $DISTELLI_DOCKER_ENDPOINT
    - echo DISTELLI_DOCKER_REPO == $DISTELLI_DOCKER_REPO
    - echo DISTELLI_DOCKER_PATH == $DISTELLI_DOCKER_PATH
  Build:
# Docker image
    - echo Build Docker image and push it to the Docker repo
    - docker login -u "$DISTELLI_DOCKER_USERNAME" -p "$DISTELLI_DOCKER_PW" $DISTELLI_DOCKER_ENDPOINT
    - docker build --quiet=false -t "$DISTELLI_DOCKER_REPO" $DISTELLI_DOCKER_PATH
    - echo Pushing to Docker repo "$DISTELLI_DOCKER_REPO"
    - docker tag "$DISTELLI_DOCKER_REPO" "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM"
    - docker push "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM"
  PkgInclude:
  PkgExclude:
  PreInstall:
    - echo "Ensuring Docker present"
    - sudo yum install -y yum-utils device-mapper-persistent-data lvm2
    - sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    - sudo yum install -y docker-ce
    - sudo systemctl start docker
  PostInstall:
  Exec:
    - echo "Exec Starting."
    - echo Attempting to kill extant WS $(sudo docker kill flask_demo)
    - sudo docker run --rm -p 80:5000 --name flask_demo wmgildersleeve/flask-demo:DISTELLI_BUILDNUM == $DISTELLI_BUILDNUM
